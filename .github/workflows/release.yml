name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for (e.g., v0.3.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Determine tag
        id: get-tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          echo "Creating release for tag: $TAG"

      - name: Validate version format
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Tag '$TAG' does not match semantic versioning pattern (e.g., v1.0.0 or v1.0.0-beta.1)"
            exit 1
          fi

      - name: Check if release already exists
        id: check-release
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release for $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release for $TAG does not exist"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get previous tag
        id: get-previous-tag
        if: steps.check-release.outputs.exists == 'false'
        run: |
          CURRENT_TAG="${{ steps.get-tag.outputs.tag }}"
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -v "^$CURRENT_TAG$" | head -n 1)
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, this might be the first release"
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREVIOUS_TAG"

      - name: Generate release notes
        id: generate-notes
        if: steps.check-release.outputs.exists == 'false'
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          PREVIOUS_TAG="${{ steps.get-previous-tag.outputs.previous_tag }}"
          
          # Use GitHub's automatic release notes generation
          RESPONSE=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name="$TAG" \
            -f previous_tag_name="$PREVIOUS_TAG")
          
          # Extract the body from the response
          NOTES=$(echo "$RESPONSE" | jq -r '.body')
          
          # Save to file to handle multiline
          echo "$NOTES" > release_notes.md
          
          echo "Release notes generated"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release
        if: steps.check-release.outputs.exists == 'false'
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          
          # Create the release
          gh release create "$TAG" \
            --title "$TAG" \
            --notes-file release_notes.md \
            --verify-tag
          
          echo "Release $TAG created successfully"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update version numbers and move tag
        if: steps.check-release.outputs.exists == 'false' && github.event_name == 'push'
        run: |
          VERSION="${{ steps.get-tag.outputs.version }}"
          TAG="${{ steps.get-tag.outputs.tag }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the current commit SHA that the tag points to
          ORIGINAL_COMMIT=$(git rev-parse "$TAG")
          echo "Tag $TAG currently points to: $ORIGINAL_COMMIT"
          
          # Make sure we're working from the tagged commit
          git checkout "$TAG"
          
          # Update CMakeLists.txt
          if grep -q "VERSION [0-9]" CMakeLists.txt; then
            sed -i "s/VERSION [0-9][0-9.]\+/VERSION $VERSION/" CMakeLists.txt
            echo "Updated CMakeLists.txt to $VERSION"
          fi
          
          # Update CITATION.cff
          if [ -f CITATION.cff ]; then
            sed -i "s/^version: .*/version: $VERSION/" CITATION.cff
            # Update date-released to today
            TODAY=$(date +%Y-%m-%d)
            sed -i "s/^date-released: .*/date-released: $TODAY/" CITATION.cff
            echo "Updated CITATION.cff to $VERSION"
          fi
          
          # Update README.md if it contains version references
          if grep -q "GIT_TAG v[0-9]" README.md; then
            sed -i "s/GIT_TAG v[0-9][0-9.]*/GIT_TAG $TAG/" README.md
            echo "Updated README.md to reference $TAG"
          fi
          
          # Check if there are any changes
          if git diff --quiet; then
            echo "No version files needed updating - version numbers already correct"
            exit 0
          fi
          
          # Commit the version changes
          git add CMakeLists.txt CITATION.cff README.md
          git commit -m "Prepare $TAG release"
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "Created version update commit: $NEW_COMMIT"
          
          # Delete the tag locally
          git tag -d "$TAG"
          
          # Re-create the tag pointing to the new commit
          git tag -a "$TAG" -m "Release $TAG"
          echo "Moved tag $TAG to new commit: $NEW_COMMIT"
          
          # Force push the tag (this will update the tag on GitHub)
          git push origin "$TAG" --force
          
          # Push the commit to main
          git push origin HEAD:main
          
          echo "‚úÖ Version numbers updated and tag moved to point to the version update commit"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Release summary
        if: steps.check-release.outputs.exists == 'false'
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          echo "‚úÖ Release $TAG created successfully!"
          echo "üîó View release: https://github.com/${{ github.repository }}/releases/tag/$TAG"

      - name: Release already exists
        if: steps.check-release.outputs.exists == 'true'
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          echo "‚ÑπÔ∏è Release $TAG already exists, skipping creation"
          echo "üîó View release: https://github.com/${{ github.repository }}/releases/tag/$TAG"
